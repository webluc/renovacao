<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fernanda & Luciano - Confirmação de Presença</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #fdfaf7;
        }
        .font-dancing {
            font-family: 'Dancing Script', cursive;
        }
        .tcard {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease-in-out;
        }
        .btn-primary {
            background-color: #8B4513; /* SaddleBrown */
            color: white;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #A0522D; /* Sienna */
        }
        .btn-secondary {
            background-color: #4CAF50; /* Green */
            color: white;
            transition: background-color 0.3s;
        }
        .btn-secondary:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-4xl">
        
        <!-- Invitation Card -->
        <div class="tcard text-center overflow-hidden mb-8">
            <div class="p-6 md:p-8">
                 <h1 class="font-dancing text-4xl md:text-6xl text-[#8B4513] mb-2 pt-6">Fernanda & Luciano</h1>
                 <p class="text-lg text-gray-600 mb-4">Convidam para a celebração da renovação de seus votos.</p>
                 <div class="flex flex-col sm:flex-row sm:justify-around items-center text-gray-700 my-6 space-y-4 sm:space-y-0">
                    <div class="text-center mx-4">
                        <p class="font-bold text-lg">09 de Agosto de 2025</p>
                        <p>às 19:00</p>
                    </div>
                    <div class="text-center mx-4">
                        <p class="font-bold text-lg">ADCAMPSUL</p>
                        <p>EQNP 26/30</p>
                        <a href="https://www.google.com/maps/search/?api=1&query=ADCAMPSUL+EQNP+26/30+Ceilândia" target="_blank" class="text-sm text-[#8B4513] hover:underline mt-1 inline-block">Ver no mapa</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- RSVP Form Card -->
        <div id="rsvp-section" class="tcard p-6 md:p-8 mb-8">
            <h2 class="text-2xl font-bold text-center mb-6 text-[#8B4513]">Confirme sua Presença</h2>
            <form id="rsvp-form" class="space-y-4" method="POST" data-netlify="true">
                <div>
                    <label for="guestName" class="block text-sm font-medium text-gray-700">Seu nome completo:</label>
                    <input type="text" id="guestName" name="guestName" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#8B4513] focus:border-[#8B4513]">
                </div>
                
                <div>
                    <p class="block text-sm font-medium text-gray-700">Você irá ao evento?</p>
                     <div class="mt-2 flex flex-col sm:flex-row sm:space-x-4 space-y-2 sm:space-y-0">
                        <label class="inline-flex items-center">
                            <input type="radio" name="attending" value="yes" class="form-radio text-[#8B4513] focus:ring-[#8B4513]" required>
                            <span class="ml-2">Sim, estarei lá!</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="attending" value="no" class="form-radio text-gray-500 focus:ring-gray-400">
                            <span class="ml-2">Não poderei comparecer.</span>
                        </label>
                    </div>
                </div>

                <!-- Companions Section -->
                <div id="companion-section" class="hidden space-y-3 pt-2">
                    <label class="block text-sm font-medium text-gray-700">Levará acompanhante(s)?</label>
                    <div id="companions-container" class="space-y-2">
                        <!-- Companion input fields will be added here dynamically -->
                    </div>
                    <button type="button" id="add-companion-btn" class="text-sm text-[#8B4513] hover:text-[#A0522D] font-semibold">+ Adicionar acompanhante</button>
                </div>
                
                <button type="submit" class="w-full btn-primary font-bold py-3 px-4 rounded-lg">
                    Enviar Resposta
                </button>
            </form>
            <div id="form-message" class="mt-4 text-center"></div>
        </div>

        <!-- Admin Section -->
        <div class="text-center">
            <button id="view-list-btn" class="btn-primary font-bold py-2 px-4 rounded-lg">
                Ver Lista de Convidados (Admin)
            </button>
        </div>

        <!-- Guest List Card (hidden by default) -->
        <div id="guest-list-section" class="tcard p-6 md:p-8 mt-8 hidden">
            <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6 space-y-4 sm:space-y-0">
                 <h2 class="text-2xl font-bold text-[#8B4513] text-center sm:text-left">Lista de Convidados</h2>
                 <button id="download-list-btn" class="btn-secondary font-bold py-2 px-4 rounded-lg w-full sm:w-auto">
                    Baixar Lista
                </button>
            </div>
            
            <h3 class="text-xl font-bold text-green-700 mb-2">Presença Confirmada</h3>
            <div id="guest-list-container" class="space-y-2">
                <p>Nenhum convidado confirmado ainda.</p>
            </div>

            <h3 class="text-xl font-bold text-red-700 mt-8 mb-2">Não Poderão Comparecer</h3>
            <div id="guest-list-declined-container" class="space-y-2">
                <p>Nenhuma ausência registrada.</p>
            </div>
        </div>
    </div>

    <!-- Password Modal -->
    <div id="password-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg p-8 w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4">Acesso Restrito</h3>
            <p class="mb-4 text-sm text-gray-600">Por favor, insira a senha para ver a lista de convidados.</p>
            <input type="password" id="password-input" class="w-full px-3 py-2 border border-gray-300 rounded-md mb-4">
            <div class="flex justify-end space-x-2">
                <button id="password-cancel" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                <button id="password-submit" class="btn-primary font-bold py-2 px-4 rounded-lg">Entrar</button>
            </div>
            <p id="password-error" class="text-red-500 text-sm mt-2"></p>
        </div>
    </div>


    <script type="module">
        // Firebase 11.6.1
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, setDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-rsvp-app';
        
        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- State ---
        let currentAttendingList = [];
        let currentDeclinedList = [];

        // --- Authentication ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("User is signed in:", user.uid);
                fetchAndDisplayGuests();
            } else {
                console.log("User is signed out.");
                const initialToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialToken) {
                    signInWithCustomToken(auth, initialToken).catch(error => {
                        console.error("Error signing in with custom token:", error);
                        signInAnonymously(auth);
                    });
                } else {
                    signInAnonymously(auth);
                }
            }
        });

        // --- DOM Elements ---
        const rsvpForm = document.getElementById('rsvp-form');
        const formMessage = document.getElementById('form-message');
        const guestNameInput = document.getElementById('guestName');
        const companionSection = document.getElementById('companion-section');
        const companionsContainer = document.getElementById('companions-container');
        const addCompanionBtn = document.getElementById('add-companion-btn');
        const attendingRadios = document.querySelectorAll('input[name="attending"]');
        
        const viewListBtn = document.getElementById('view-list-btn');
        const passwordModal = document.getElementById('password-modal');
        const passwordInput = document.getElementById('password-input');
        const passwordSubmit = document.getElementById('password-submit');
        const passwordCancel = document.getElementById('password-cancel');
        const passwordError = document.getElementById('password-error');
        
        const guestListSection = document.getElementById('guest-list-section');
        const guestListContainer = document.getElementById('guest-list-container');
        const guestListDeclinedContainer = document.getElementById('guest-list-declined-container');
        const downloadListBtn = document.getElementById('download-list-btn');

        const ADMIN_PASSWORD = "Lucen@2025";
        
        // --- Firestore Collection Reference ---
        const rsvpCollectionRef = collection(db, `artifacts/${appId}/public/data/rsvps`);

        // --- Functions ---
        
        // Creates a new companion input field
        function createCompanionInput() {
            const companionDiv = document.createElement('div');
            companionDiv.className = 'flex items-center space-x-2 animate-fade-in';
            const newInput = document.createElement('input');
            newInput.type = 'text';
            newInput.className = 'companion-input mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#8B4513] focus:border-[#8B4513]';
            newInput.placeholder = 'Nome completo do acompanhante';
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.innerHTML = '&times;';
            removeBtn.className = 'flex-shrink-0 flex items-center justify-center w-6 h-6 bg-red-500 text-white font-bold rounded-full hover:bg-red-700 transition-colors';
            removeBtn.title = 'Remover acompanhante';
            removeBtn.addEventListener('click', () => { companionDiv.remove(); });
            companionDiv.appendChild(newInput);
            companionDiv.appendChild(removeBtn);
            companionsContainer.appendChild(companionDiv);
            newInput.focus();
        }

        // Display form messages
        function showMessage(message, type) {
            formMessage.textContent = message;
            formMessage.className = `mt-4 text-center p-2 rounded-md ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
            setTimeout(() => {
                formMessage.textContent = '';
                formMessage.className = 'mt-4 text-center';
            }, 5000);
        }
        
        // Fetch and display guests in real-time
        function fetchAndDisplayGuests() {
            onSnapshot(rsvpCollectionRef, (snapshot) => {
                let attending = [];
                let declining = [];
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    if(data.isAttending){ attending.push(data); } else { declining.push(data); }
                });
                attending.sort((a, b) => a.guestName.localeCompare(b.guestName));
                declining.sort((a, b) => a.guestName.localeCompare(b.guestName));
                
                // Update global state for download function
                currentAttendingList = attending;
                currentDeclinedList = declining;

                // Display attending guests
                guestListContainer.innerHTML = '';
                if (attending.length > 0) {
                    attending.forEach(guest => {
                        const guestEl = document.createElement('div');
                        guestEl.className = 'p-3 bg-green-50 rounded-md';
                        let text = `<span class="font-bold">${guest.guestName}</span>`;
                        if (guest.companions && guest.companions.length > 0) {
                            text += ` + <span class="text-gray-700">${guest.companions.join(', ')}</span>`;
                        }
                        guestEl.innerHTML = text;
                        guestListContainer.appendChild(guestEl);
                    });
                } else {
                    guestListContainer.innerHTML = '<p class="text-gray-500">Nenhum convidado confirmado ainda.</p>';
                }

                // Display declining guests
                guestListDeclinedContainer.innerHTML = '';
                 if (declining.length > 0) {
                    declining.forEach(guest => {
                        const guestEl = document.createElement('div');
                        guestEl.className = 'p-3 bg-red-50 rounded-md text-gray-600 italic';
                        guestEl.textContent = guest.guestName;
                        guestListDeclinedContainer.appendChild(guestEl);
                    });
                } else {
                    guestListDeclinedContainer.innerHTML = '<p class="text-gray-500">Nenhuma ausência registrada.</p>';
                }
            }, (error) => {
                console.error("Error fetching guest list:", error);
                guestListContainer.innerHTML = '<p class="text-red-500">Erro ao carregar a lista de convidados.</p>';
            });
        }

        // Download list as CSV
        function downloadGuestList() {
            let csvContent = "Status,Nome Principal,Acompanhantes\n";
            
            currentAttendingList.forEach(guest => {
                const companionNames = guest.companions ? guest.companions.join("; ") : "";
                csvContent += `"Confirmado","${guest.guestName}","${companionNames}"\n`;
            });

            currentDeclinedList.forEach(guest => {
                csvContent += `"Não Virá","${guest.guestName}",""\n`;
            });

            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "lista_convidados_fernanda_e_luciano.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // --- Event Listeners ---
        
        // Show/hide companion section based on attendance
        attendingRadios.forEach(radio => {
            radio.addEventListener('change', (event) => {
                if (event.target.value === 'yes') {
                    companionSection.classList.remove('hidden');
                } else {
                    companionSection.classList.add('hidden');
                    companionsContainer.innerHTML = ''; 
                }
            });
        });

        // Add companion button
        addCompanionBtn.addEventListener('click', createCompanionInput);
        
        // Handle RSVP form submission
        rsvpForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const guestName = guestNameInput.value.trim();
            const isAttending = rsvpForm.elements.attending.value === 'yes';
            const companionInputs = document.querySelectorAll('.companion-input');
            const companions = Array.from(companionInputs).map(input => input.value.trim()).filter(name => name); 

            if (!guestName) {
                showMessage('Por favor, preencha seu nome.', 'error');
                return;
            }

            try {
                const docId = guestName.toLowerCase().replace(/[^a-z0-9]/g, '');
                const rsvpRef = doc(db, `artifacts/${appId}/public/data/rsvps`, docId);
                await setDoc(rsvpRef, {
                    guestName: guestName,
                    isAttending: isAttending,
                    companions: isAttending ? companions : [],
                    submittedAt: new Date()
                });
                showMessage('Sua resposta foi enviada com sucesso! Obrigado.', 'success');
                rsvpForm.reset();
                companionsContainer.innerHTML = '';
                companionSection.classList.add('hidden');
            } catch (error) {
                console.error("Error adding document: ", error);
                showMessage('Ocorreu um erro ao enviar sua resposta. Tente novamente.', 'error');
            }
        });

        // Admin list view logic
        viewListBtn.addEventListener('click', () => {
            passwordModal.classList.remove('hidden');
            passwordInput.focus();
        });
        passwordCancel.addEventListener('click', () => {
            passwordModal.classList.add('hidden');
            passwordInput.value = '';
            passwordError.textContent = '';
        });
        passwordSubmit.addEventListener('click', () => {
            if (passwordInput.value === ADMIN_PASSWORD) {
                passwordModal.classList.add('hidden');
                guestListSection.classList.remove('hidden');
                passwordInput.value = '';
                passwordError.textContent = '';
            } else {
                passwordError.textContent = 'Senha incorreta.';
            }
        });
        passwordInput.addEventListener('keyup', (e) => {
             if (e.key === 'Enter') { passwordSubmit.click(); }
        });
        
        // Download button listener
        downloadListBtn.addEventListener('click', downloadGuestList);

    </script>
</body>
</html>
